<section id="products" class="pg-section">
  <div class="pg-container">
    <div class="pg-grid">
      {% for block in section.blocks %}
        {% assign p = block.settings.product %}
        {% if p %}
          <div class="pg-card fade-in" onclick="openModal({{ forloop.index0 }})" {{ block.shopify_attributes }}>
            <div class="pg-image">
              {% if p.featured_image %}
                <img
                  src="{{ p.featured_image | image_url: width: 900 }}"
                  alt="{{ p.featured_image.alt | default: p.title | escape }}">
              {% endif %}
              <div class="pg-plus">+</div>
            </div>
            <div class="pg-meta">
              <h3 class="pg-title">{{ p.title }}</h3>
              <span class="pg-price">
                {% if p.price_varies %}
                  From {{ p.price_min | money }}
                {% else %}
                  {{ p.price | money }}
                {% endif %}
              </span>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>

  <!-- Modal -->
  <div class="pg-modal" id="pgModal" aria-hidden="true">
    <div class="pg-modal__content" role="dialog" aria-modal="true">
      <button class="pg-modal__close" id="pgClose" aria-label="Close">&times;</button>
      <div class="pg-modal__product">
        <div class="pg-modal__image"><img id="pgImg" src="" alt=""></div>
        <div class="pg-modal__details">
          <h2 id="pgTitle"></h2>
          <div id="pgPrice"></div>
          <p id="pgDesc"></p>

          <div id="pgVariantWrap" style="display:none">
            <label for="pgVariant">Select variant</label>
            <select id="pgVariant" class="pg-select"></select>
          </div>

          <button class="pg-add" id="pgAdd">Add to cart</button>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
.pg-container{max-width:1200px;margin:0 auto;padding:0 20px}
.pg-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px}
.pg-card{cursor:pointer;border-radius:8px;overflow:hidden;box-shadow:0 4px 10px rgba(0,0,0,.08);background:#fff;transition:transform .25s}
.pg-card:hover{transform:translateY(-4px)}
.pg-image{position:relative;background:#f5f5f5}
.pg-image img{display:block;width:100%;height:260px;object-fit:cover}
.pg-plus{position:absolute;inset:auto 12px 12px auto;width:44px;height:44px;border-radius:50%;background:#fff;border:2px solid #333;display:flex;align-items:center;justify-content:center;font-weight:700}
.pg-meta{padding:14px}
.pg-title{font-size:16px;margin:0 0 6px}
.pg-price{font-weight:700}
.fade-in{opacity:0;transform:translateY(24px);transition:all .5s}
.fade-in.visible{opacity:1;transform:translateY(0)}
/* modal */
.pg-modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:.3s}
.pg-modal.active{opacity:1;visibility:visible}
.pg-modal__content{background:#fff;border-radius:10px;max-width:760px;width:92%;max-height:90vh;overflow:auto;position:relative;transform:translateY(30px);transition:transform .3s}
.pg-modal.active .pg-modal__content{transform:translateY(0)}
.pg-modal__close{position:absolute;top:14px;right:16px;background:none;border:0;font-size:28px;cursor:pointer}
.pg-modal__product{display:flex;flex-wrap:wrap}
.pg-modal__image{flex:1;min-width:280px}
.pg-modal__image img{width:100%;height:340px;object-fit:cover;border-radius:10px 0 0 10px}
.pg-modal__details{flex:1;min-width:300px;padding:24px}
.pg-select{width:100%;padding:12px;border:1px solid #ddd;border-radius:6px;margin:10px 0 16px}
.pg-add{width:100%;padding:14px 20px;background:#333;color:#fff;border:0;border-radius:6px;font-weight:700;cursor:pointer}
.pg-add:hover{background:#555}
@media (max-width:768px){
  .pg-modal__product{flex-direction:column}
  .pg-modal__image img{border-radius:10px 10px 0 0;height:260px}
}
</style>

<script>
/* Build product data from selected products (blocks) */
window.pgProducts = [
  {% for block in section.blocks %}
    {% assign p = block.settings.product %}
    {% if p %}
    {
      id: {{ p.id | json }},
      title: {{ p.title | json }},
      description: {{ p.description | strip_html | json }},
      price_html: {{ p.price | money | json }},
      price_min_html: {{ p.price_min | money | json }},
      price_varies: {{ p.price_varies | json }},
      image: {{ p.featured_image | image_url: width: 1200 | json }},
      image_alt: {{
        p.featured_image.alt | default: p.title
        | replace: '-', ' ' | replace: '_', ' '
        | json
      }},
      variants: [
        {% for v in p.variants %}
        { id: {{ v.id | json }}, title: {{ v.title | json }}, available: {{ v.available | json }}, price_html: {{ v.price | money | json }} }{% unless forloop.last %},{% endunless %}
        {% endfor %}
      ]
    }{% unless forloop.last %},{% endunless %}
    {% endif %}
  {% endfor %}
];

document.addEventListener('DOMContentLoaded',()=>{
  // reveal on scroll
  const show=()=>document.querySelectorAll('.fade-in').forEach(el=>{
    const r=el.getBoundingClientRect(); if(r.top<innerHeight-40) el.classList.add('visible');
  });
  addEventListener('scroll',show); show();

  const modal=document.getElementById('pgModal');
  const img=document.getElementById('pgImg');
  const title=document.getElementById('pgTitle');
  const price=document.getElementById('pgPrice');
  const desc=document.getElementById('pgDesc');
  const vWrap=document.getElementById('pgVariantWrap');
  const vSel=document.getElementById('pgVariant');
  const add=document.getElementById('pgAdd');
  const close=document.getElementById('pgClose');

  let current=null;

  window.openModal=(i)=>{
    const p=(window.pgProducts||[])[i]; if(!p) return;
    current=p;
    img.src=p.image||''; img.alt=p.image_alt||p.title||'';
    title.textContent=p.title||'';
    price.textContent=p.price_varies ? ('From '+(p.price_min_html||'')) : (p.price_html||'');
    desc.textContent=p.description||'';
    vSel.innerHTML='';
    if(p.variants && p.variants.length>0){
      p.variants.forEach(v=>{
        const opt=document.createElement('option');
        opt.value=v.id; opt.textContent=v.title+' â€” '+v.price_html+(v.available?'':' (Sold out)');
        opt.disabled=!v.available; vSel.appendChild(opt);
      });
      vWrap.style.display='block';
    } else { vWrap.style.display='none'; }
    modal.classList.add('active'); document.body.style.overflow='hidden';
  };

  function closeModal(){ modal.classList.remove('active'); document.body.style.overflow='auto'; }
  close.addEventListener('click',closeModal);
  modal.addEventListener('click',e=>{ if(e.target===modal) closeModal(); });
  document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeModal(); });

  add.addEventListener('click', async ()=>{
    if(!current) return;
    const variantId = (vWrap.style.display!=='none' && vSel.value) ? Number(vSel.value)
                      : Number(current.variants?.[0]?.id || 0);
    if(!variantId){ alert('This product is unavailable.'); return; }
    try{
      await fetch('/cart/add.js',{ method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'}, body:JSON.stringify({id:variantId,quantity:1}) });
      alert('Added to cart!');
      closeModal();
    }catch(err){ alert('Could not add to cart.'); }
  });
});
</script>

{% schema %}
{
  "name": "Product Modal",
  "settings": [],
  "blocks": [
    { "type": "product", "name": "Product", "settings": [ { "type": "product", "id": "product", "label": "Select product" } ] }
  ],
  "max_blocks": 24,
  "presets": [{ "name": "Product Modal" }]
}
{% endschema %}